{* LIST TEXT "M3U Playlist" *}
{if !isset($extra)}
{php}
$files = $this->get_template_vars('files');
$ids = '';
foreach($files as $i => $file)
	$ids .= $file['id'] . ',';
$ids = substr($ids, 0, strlen($ids)-1);
    
$this->assign('ids', $ids);
if(!isset($_GET['item']) && !isset($_GET['id']))
{
	header('Location: ' . generate_href('list=m3u&plugin=list&cat=' . $_REQUEST['cat']));
}
{/php}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>{$smarty.const.HTML_NAME}: M3U List</title>
</head>
<body>
Note: All non-media types will be filtered out using this list type.<br />
Select your audio/video format:<br />
<a href="{'plugin=list&list=m3u&cat='|cat:$cat|cat:'&item='|cat:$ids|cat:'&extra=mp3&filename=Files.m3u'|generate_href}">mp4</a>
: <a href="{'plugin=list&list=m3u&cat='|cat:$cat|cat:'&item='|cat:$ids|cat:'&extra=mpg&filename=Files.m3u'|generate_href}">mpg/mp3</a>
: <a href="{'plugin=list&list=m3u&cat='|cat:$cat|cat:'&item='|cat:$ids|cat:'&extra=wm&filename=Files.m3u'|generate_href}">wmv/wma</a>
<br />
Some files that will be listed: <br />
{php}
$files = $this->get_template_vars('files');
$count = 0;
foreach($files as $i => $file)
{
	$type = split('/', $file['Filemime']);
	if($type[0] == 'audio' || $type[0] == 'video')
    {
    	print $file['Filename'] . '<br />';
        $count++;
    }
    if($count == 10)
    	break;
}
{/php}
</body>
</html>
{elseif $extra == 'mp4'}
{php}
header('Content-Type: audio/x-mpegurl');
header('Content-Disposition: attachment; filename="' . (isset($_REQUEST['filename'])?$_REQUEST['filename']:constant($_REQUEST['cat'] . '::NAME') . '.m3u"')); 
{/php}
#EXTM3U
{section name=file loop=$files}
{assign var=length value=0}
{if isset($files[file].Length)}{assign var=length value=$files[file].Length|ceil}{/if}
{assign var=title value=$files[file].Filename}
{if isset($files[file].Artist) && isset($files[file].Title)}{assign var=title value=$files[file].Artist|cat:' - '|cat:$files[file].Title}{/if}
{assign var=type_arr value='/'|@split:$files[file].Filemime}
{assign var=type value=$type_arr.0}
{if $type=="video"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/mp4/'|cat:$files[file].Filename'|generate_href}.mp4
{elseif $type=="audio"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/mp4a/'|cat:$files[file].Filename'|generate_href}.mp4
{/if}
{/section}
{elseif $extra == 'wm'}
{php}
header('Content-Type: audio/x-mpegurl');
header('Content-Disposition: attachment; filename="' . (isset($_REQUEST['filename'])?$_REQUEST['filename']:constant($_REQUEST['cat'] . '::NAME') . '.m3u"')); 
{/php}
#EXTM3U
{section name=file loop=$files}
{assign var=length value=0}
{if isset($files[file].Length)}{assign var=length value=$files[file].Length|ceil}{/if}
{assign var=title value=$files[file].Filename}
{if isset($files[file].Artist) && isset($files[file].Title)}{assign var=title value=$files[file].Artist|cat:' - '|cat:$files[file].Title}{/if}
{assign var=type_arr value='/'|@split:$files[file].Filemime}
{assign var=type value=$type_arr.0}
{if $type=="video"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/wmv/'|cat:$files[file].Filename'|generate_href}.mp4
{elseif $type=="audio"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/wma/'|cat:$files[file].Filename'|generate_href}.mp4
{/if}
{/section}
{elseif $extra == 'mpg'}
{php}
header('Content-Type: audio/x-mpegurl');
header('Content-Disposition: attachment; filename="' . (isset($_REQUEST['filename'])?$_REQUEST['filename']:constant($_REQUEST['cat'] . '::NAME') . '.m3u"')); 
{/php}
#EXTM3U
{section name=file loop=$files}
{assign var=length value=0}
{if isset($files[file].Length)}{assign var=length value=$files[file].Length|ceil}{/if}
{assign var=title value=$files[file].Filename}
{if isset($files[file].Artist) && isset($files[file].Title)}{assign var=title value=$files[file].Artist|cat:' - '|cat:$files[file].Title}{/if}
{assign var=type_arr value='/'|@split:$files[file].Filemime}
{assign var=type value=$type_arr.0}
{if $type=="video"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/mpg/'|cat:$files[file].Filename'|generate_href}.mp4
{elseif $type=="audio"}
#EXTINF:{$length},{$title}
{$smarty.const.HTML_DOMAIN}{'encode/'|cat:$cat|cat:'/'|cat:$files[file].id|cat:'/mp3/'|cat:$files[file].Filename'|generate_href}.mp4
{/if}
{/section}
{/if}